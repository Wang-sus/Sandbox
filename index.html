<!DOCTYPE HTML>
<html>
	<head>
		<title>Sandbox Alpha</title>

		<!-- Character encoding -->
		<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

		<!-- Stylesheet -->
		<link href="style/main.css" rel="stylesheet" type="text/css">

		<!-- Modules -->
		<script src="js/glMatrix-1.2.min.js" type="text/javascript"></script>
		<script src="js/blocks.js" type="text/javascript"></script>
		<script src="js/helpers.js" type="text/javascript"></script>
		<script src="js/world.js" type="text/javascript"></script>
		<script src="js/render.js" type="text/javascript"></script>
		<script src="js/physics.js" type="text/javascript"></script>
		<script src="js/player.js" type="text/javascript"></script>
	</head>

	<body oncontextmenu="return false">
		<!-- Render surface -->
		<canvas id="renderSurface"></canvas>

		<!-- Material selection -->
		<table id="materialSelector">
			<tr></tr>
		</table>

		<!-- Initialisation code -->
		<script type="text/javascript">			
			// Create a new flat world
			var world = new World( 8, 8, 8 );
			world.createFlatWorld( 6 );

			// Set up renderer
			var render = new Renderer( "renderSurface" );
			render.setWorld( world, 8 );
			render.setPerspective( 90, 0.01, 200 );

			// Create physics simulator
			var physics = new Physics();
			physics.setWorld( world );

			// Create new local player
			var player = new Player();
			player.setWorld( world );
			player.setInputCanvas( "renderSurface" );
			player.setMaterialSelector( "materialSelector" );

			// Render loop			
			setInterval( function()
			{
				var time = new Date().getTime() / 1000.0;

				// Simulate physics
				physics.simulate();

				// Update local player
				player.update();

				// Build a chunk
				render.buildChunks( 1 );

				// Draw world
				render.setCamera( player.getEyePos().toArray(), player.angles );
				render.draw();

				while ( new Date().getTime() / 1000 - time < 0.016 );
			}, 1 );
		</script>
				<div id="container">
		<div id="loadFiles">
			<table width="854">
				<tr>
					<td>
						<i>OBJ:</i>
						<input id="selectFileOBJ" type="file"></input>
					</td>
					<td>
						<i>MTL:</i>
						<input id="selectFileMTL" type="file"></input>
					</td>
					<td>
						<button onclick="actionButton()">View</button>
					</td>
				</tr>
			</table>
			<script type="text/javascript">				
				// Event that loads the OBJ file in "g_fileOBJString".
				function readFileOBJ(evt) {
					var f = evt.target.files[0]; 
					if (f) {
						var r = new FileReader();
						r.onload = function(e) { 
							g_fileOBJString = e.target.result;
						}
						r.readAsText(f);
					} else { 
						alert("Failed to load file.");
					}
				}
				document.getElementById('selectFileOBJ')
					.addEventListener('change', readFileOBJ, false);
				
				// Event that loads the OBJ file in "g_fileMTLString".
				function readFileMTL(evt) {
					var f = evt.target.files[0]; 
					if (f) {
						var r = new FileReader();
						r.onload = function(e) { 
							g_fileMTLString = e.target.result;
						}
						r.readAsText(f);
					} else { 
						alert("Failed to load file.");
					}
				}
				document.getElementById('selectFileMTL')
					.addEventListener('change', readFileMTL, false);
				
				/* Init Button's Action: inits the viewer if we've got
				 * both files.
				 */
				function actionButton() {
					if ((g_fileOBJString) && (g_fileMTLString)) {
						initOBJViewer();
					} else {
						alert("It needs both files.");
					}
				}
			</script>			
</div>
</div>
	</body>
</html>
